---
- hosts: switches
  name: Configure TP-Link Switch VLANs
  gather_facts: yes
  connection: local
  
  tasks:
    - name: Build VLAN list
      set_fact:
        all_vlans: "{{ common_vlans + (additional_vlans | default([])) }}"
    
    - name: Build port configuration
      set_fact:
        port_config: "{{ lookup('template', '~/ansible_collection_tp-link_switches/easy_smart/templates/port_config.j2') | from_yaml }}"
    
    - name: Build VLAN configuration directly
      set_fact:
        vlan_config: |
          [
            {% for vlan in all_vlans %}
            {
              "vlan_id": {{ vlan.id }},
              "name": "{{ vlan.name }}",
              "tagged_ports": [{{ port_roles.management_trunk }}{% if port_roles.get('uplink') %}, {{ port_roles.uplink }}{% endif %}]
              {% if vlan.id == 10 and port_roles.management_access %}
              , "untagged_ports": {{ port_roles.management_access | to_json }}
              {% elif vlan.id == 20 and port_roles.clients %}
              , "untagged_ports": {{ port_roles.clients | to_json }}
              {% elif vlan.id == 30 and port_roles.guests %}
              , "untagged_ports": {{ port_roles.guests | to_json }}
              {% elif vlan.id == 40 and port_roles.iot %}
              , "untagged_ports": {{ port_roles.iot | to_json }}
              {% endif %}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
          ]
    
    - name: Show configuration preview
      debug:
        msg:
          - "Switch: {{ inventory_hostname }} ({{ switch_model }})"
          - "Total Ports: {{ total_ports }}"
          - "VLANs: {{ vlan_config | map(attribute='name') | list }}"
          - "Management Trunk: Port {{ port_roles.management_trunk }}"
    
    - name: Configure switch with VLANs
      rgl.tp_link_easy_smart_switch.smrt_config:
        switch_mac_address: "{{ smrt_mac_address }}"
        host_mac_address: "{{ ansible_default_ipv4.macaddress }}"
        host_ip_address: "{{ management_host_ip }}"
        username: "{{ admin_username }}"
        password: "{{ admin_password }}"
        vlans: "{{ vlan_config }}"
        ports: "{{ port_config }}"
      delegate_to: localhost
      register: result
    
    - name: Show result
      debug:
        msg: "âœ“ Configuration applied to {{ inventory_hostname }}"
      when: result is succeeded
