---
# =============================================================================
# Configuration Backup - Local Storage
# =============================================================================
#
# This playbook backs up switch configurations to local files.
# Unreachable switches are detected early and skipped.
#
# Usage:
#   # Create backup
#   ansible-playbook playbooks/config-backup-local.yml
#
#   # Restore from backup (uncomment restore section first)
#   ansible-playbook playbooks/config-backup-local.yml -e "restore_enabled=true"
#
# =============================================================================

- name: Configuration Backup/Restore (Local Storage)
  hosts: managed_switches
  gather_facts: no
  
  vars:
    # -------------------------------------------------------------------------
    # Backup Settings
    # -------------------------------------------------------------------------
    backup_dir: "./backups"
    
    # -------------------------------------------------------------------------
    # Restore Settings (disabled by default)
    # -------------------------------------------------------------------------
    restore_enabled: false
    # Set this to the backup file you want to restore:
    # restore_file: "./backups/SG3210_10-0-10-1_2026-02-01_170000.cfg"
    
    # -------------------------------------------------------------------------
    # Connectivity Settings
    # -------------------------------------------------------------------------
    ssh_check_timeout: 5
    
  tasks:
    # =========================================================================
    # PRE-FLIGHT: Check SSH Connectivity
    # =========================================================================
    
    - name: "PRE-CHECK: Verify switch is reachable via SSH"
      wait_for:
        host: "{{ ansible_host }}"
        port: 22
        timeout: "{{ ssh_check_timeout }}"
      register: ssh_check
      ignore_errors: yes
      
    - name: "PRE-CHECK: Skip unreachable switches"
      meta: end_host
      when: ssh_check is failed
      
    # =========================================================================
    # BACKUP SECTION
    # =========================================================================
    
    - name: "BACKUP: Create local backup from running-config"
      tp_link_config_backup:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user | default('admin') }}"
        password: "{{ ansible_password | default('neinnein') }}"
        hostname: "{{ cli.hostname | default('SG3210') }}"
        action: backup_local
        backup_dir: "{{ backup_dir }}"
      register: backup_result
      when: not restore_enabled
      
    - name: "BACKUP: Display result"
      debug:
        msg:
          - "================================================"
          - "Local Backup Completed"
          - "================================================"
          - "Host: {{ ansible_host }}"
          - "Backup file: {{ backup_result.backup_path }}"
          - "Backup size: {{ backup_result.backup_size }} bytes"
          - "================================================"
      when: 
        - not restore_enabled
        - backup_result is defined
        - backup_result.backup_path is defined
      
    # =========================================================================
    # RESTORE SECTION (disabled by default)
    # =========================================================================
    
    - name: "RESTORE: Apply configuration from local file"
      tp_link_config_backup:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user | default('admin') }}"
        password: "{{ ansible_password | default('neinnein') }}"
        hostname: "{{ cli.hostname | default('SG3210') }}"
        action: restore_local
        config_file: "{{ restore_file }}"
      register: restore_result
      when: 
        - restore_enabled
        - restore_file is defined
      
    - name: "RESTORE: Display result"
      debug:
        msg:
          - "================================================"
          - "Configuration Restored"
          - "================================================"
          - "Host: {{ ansible_host }}"
          - "Config file: {{ restore_file }}"
          - "Commands applied: {{ restore_result.commands_applied }}"
          - "================================================"
          - ""
          - "WARNING: Reboot switch to fully apply restored config!"
      when:
        - restore_enabled
        - restore_result is defined
        - restore_result.commands_applied is defined
