---
# =============================================================================
# Configure Ports on TP-Link SG3210 Switches
# =============================================================================
#
# This playbook configures trunk and access ports on TP-Link SG3210 switches.
# Unreachable switches are detected early and skipped.
#
# Usage:
#   ansible-playbook playbooks/configure-ports.yml
#
# Variables can be overridden:
#   ansible-playbook playbooks/configure-ports.yml -e "port_mode=replace"
#
# =============================================================================

- name: Configure Ports on SG3210 Switches
  hosts: managed_switches
  gather_facts: no
  
  vars:
    # -------------------------------------------------------------------------
    # Operation Mode
    # -------------------------------------------------------------------------
    # "add"     - Only add VLAN memberships, do not remove existing ones
    # "replace" - Remove all VLANs from port first, then configure new
    port_mode: "replace"
    
    # -------------------------------------------------------------------------
    # Trunk Ports Configuration
    # -------------------------------------------------------------------------
    # Trunk ports carry multiple VLANs (tagged)
    # Typically used for uplinks and inter-switch connections
    trunk_ports:
      - port: 1
        vlans: [1, 10, 20, 30, 40, 50]
    
    # -------------------------------------------------------------------------
    # Access Ports Configuration
    # -------------------------------------------------------------------------
    # Access ports carry a single VLAN (untagged)
    # Typically used for end devices (PCs, phones, printers)
    access_ports:
      - port: 2
        vlan: 10
      - port: 3
        vlan: 20
      - port: 4
        vlan: 20
      - port: 5
        vlan: 20
      - port: 6
        vlan: 20
      - port: 7
        vlan: 40
      - port: 8
        vlan: 50
    
    # -------------------------------------------------------------------------
    # Connectivity Settings
    # -------------------------------------------------------------------------
    ssh_check_timeout: 5
    
  tasks:
    # =========================================================================
    # PRE-FLIGHT: Check SSH Connectivity
    # =========================================================================
    
    - name: "PRE-CHECK: Verify switch is reachable via SSH"
      wait_for:
        host: "{{ ansible_host }}"
        port: 22
        timeout: "{{ ssh_check_timeout }}"
      register: ssh_check
      ignore_errors: yes
      
    - name: "PRE-CHECK: Skip unreachable switches"
      meta: end_host
      when: ssh_check is failed
      
    # =========================================================================
    # PORT CONFIGURATION
    # =========================================================================
    
    - name: "Configure ports (mode: {{ port_mode }})"
      tp_link_batch_port_expect:
        host: "{{ ansible_host }}"
        username: "{{ ansible_user | default('admin') }}"
        password: "{{ ansible_password | default('neinnein') }}"
        hostname: "{{ cli.hostname | default('SG3210') }}"
        mode: "{{ port_mode }}"
        trunk_ports: "{{ trunk_ports }}"
        access_ports: "{{ access_ports }}"
      register: port_result
      
    # =========================================================================
    # SUMMARY
    # =========================================================================
    
    - name: "Display port configuration result"
      debug:
        msg:
          - "================================================"
          - "Port Configuration Completed"
          - "================================================"
          - "Host: {{ ansible_host }}"
          - "Mode: {{ port_mode }}"
          - "Trunk ports configured: {{ port_result.trunk_ports_configured }}"
          - "Access ports configured: {{ port_result.access_ports_configured }}"
          - "================================================"
          - ""
          - "Trunk Ports:"
          - "{% for port in trunk_ports %}  - Port {{ port.port }}: VLANs {{ port.vlans }} (tagged)\n{% endfor %}"
          - ""
          - "Access Ports:"
          - "{% for port in access_ports %}  - Port {{ port.port }}: VLAN {{ port.vlan }} (untagged)\n{% endfor %}"
          - ""
          - "Verify with: show interface switchport"
          - "================================================"
