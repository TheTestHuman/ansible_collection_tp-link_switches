---
- name: Configure Port Security on SG3210
  hosts: managed_switches
  gather_facts: no
  connection: local
  
  vars:
    switch_host: "{{ ansible_host }}"
    switch_user: "admin"
    switch_pass: "neinnein"
    
  tasks:
    - name: Enable port security on management ports (max 1 MAC, permanent)
      tp_link_port_security_expect:
        host: "{{ switch_host }}"
        username: "{{ switch_user }}"
        password: "{{ switch_pass }}"
        port: "{{ item }}"
        max_mac_count: 1
        mode: permanent
        status: drop
        exceed_notification: true
        state: present
      loop: "{{ port_roles.management_access }}"
      register: management_security
      
    - name: Enable port security on client ports (max 3 MACs, dynamic)
      tp_link_port_security_expect:
        host: "{{ switch_host }}"
        username: "{{ switch_user }}"
        password: "{{ switch_pass }}"
        port: "{{ item }}"
        max_mac_count: 3
        mode: dynamic
        status: forward
        exceed_notification: true
        state: present
      loop: "{{ port_roles.clients }}"
      register: client_security
      
    - name: Enable port security on guest ports (max 5 MACs, dynamic)
      tp_link_port_security_expect:
        host: "{{ switch_host }}"
        username: "{{ switch_user }}"
        password: "{{ switch_pass }}"
        port: "{{ item }}"
        max_mac_count: 5
        mode: dynamic
        status: forward
        exceed_notification: false
        state: present
      loop: "{{ port_roles.guests }}"
      register: guest_security
      
    - name: Enable port security on IoT ports (max 2 MACs, static)
      tp_link_port_security_expect:
        host: "{{ switch_host }}"
        username: "{{ switch_user }}"
        password: "{{ switch_pass }}"
        port: "{{ item }}"
        max_mac_count: 2
        mode: static
        status: drop
        exceed_notification: true
        state: present
      loop: "{{ port_roles.iot }}"
      register: iot_security
      
    - name: Summary
      debug:
        msg:
          - "================================================"
          - "Port Security Configuration Completed"
          - "================================================"
          - "Management Ports ({{ port_roles.management_access | join(', ') }}): Max 1 MAC (permanent, drop)"
          - "Client Ports ({{ port_roles.clients | join(', ') }}): Max 3 MACs (dynamic, forward)"
          - "Guest Ports ({{ port_roles.guests | join(', ') }}): Max 5 MACs (dynamic, forward)"
          - "IoT Ports ({{ port_roles.iot | join(', ') }}): Max 2 MACs (static, drop)"
          - "================================================"
          - ""
          - "Verify with: show mac address-table max-mac-count"
          - "         or: show mac address-table max-mac-count interface gigabitEthernet 1/0/2"
