---
# =============================================================================
# Configure ALL Managed Switches
# =============================================================================
# Konfiguriert VLANs und Ports auf allen TP-Link SG3210 Switches
#
# Verwendung:
#   ansible-playbook playbooks/production/configure-all-switches.yml
#   ansible-playbook playbooks/production/configure-all-switches.yml --limit switch-sg3210-office
#   ansible-playbook playbooks/production/configure-all-switches.yml -e "vlan_mode=add"
#   ansible-playbook playbooks/production/configure-all-switches.yml -e "port_mode=add"
#
# Modi:
#   replace (default) - Löscht bestehende Config, dann neu konfigurieren
#   add               - Fügt nur hinzu, löscht nichts
# =============================================================================

- name: Configure ALL Managed Switches
  hosts: managed_switches
  gather_facts: no
  connection: local
  
  vars:
    # Konfigurationsmodi (überschreibbar via -e)
    vlan_mode: "replace"
    port_mode: "replace"
  
  tasks:
    # =========================================================================
    # PHASE 1: VLAN Configuration
    # =========================================================================
    - name: "{{ inventory_hostname }} | Configure VLANs (mode: {{ vlan_mode }})"
      tp_link_batch_vlan_expect:
        host: "{{ ansible_host }}"
        username: "{{ vault_switch_user }}"
        password: "{{ vault_switch_password }}"
        vlans: "{{ common_vlans }}"
        hostname: "{{ cli.hostname | default('SG3210') }}"
        mode: "{{ vlan_mode }}"
        protected_vlans: "{{ protected_vlans | default([1]) }}"
      register: vlan_result

    # =========================================================================
    # PHASE 2: Build Access Port List
    # =========================================================================
    - name: "{{ inventory_hostname }} | Initialize access port list"
      set_fact:
        access_port_list: []

    - name: "{{ inventory_hostname }} | Add management access ports (VLAN 10)"
      set_fact:
        access_port_list: "{{ access_port_list + [{'port': item, 'vlan': 10}] }}"
      loop: "{{ port_roles.management_access | default([]) }}"

    - name: "{{ inventory_hostname }} | Add client ports (VLAN 20)"
      set_fact:
        access_port_list: "{{ access_port_list + [{'port': item, 'vlan': 20}] }}"
      loop: "{{ port_roles.clients | default([]) }}"

    - name: "{{ inventory_hostname }} | Add guest ports (VLAN 30)"
      set_fact:
        access_port_list: "{{ access_port_list + [{'port': item, 'vlan': 30}] }}"
      loop: "{{ port_roles.guests | default([]) }}"

    - name: "{{ inventory_hostname }} | Add IoT ports (VLAN 40)"
      set_fact:
        access_port_list: "{{ access_port_list + [{'port': item, 'vlan': 40}] }}"
      loop: "{{ port_roles.iot | default([]) }}"

    # =========================================================================
    # PHASE 3: Port Configuration (ALL ports in ONE SSH session!)
    # =========================================================================
    - name: "{{ inventory_hostname }} | Configure ALL Ports (mode: {{ port_mode }})"
      tp_link_batch_port_expect:
        host: "{{ ansible_host }}"
        username: "{{ vault_switch_user }}"
        password: "{{ vault_switch_password }}"
        hostname: "{{ cli.hostname | default('SG3210') }}"
        mode: "{{ port_mode }}"
        trunk_ports:
          - port: "{{ port_roles.management_trunk }}"
            vlans: "{{ common_vlans | map(attribute='id') | list }}"
        access_ports: "{{ access_port_list }}"
      register: port_result

    # =========================================================================
    # PHASE 4: Summary
    # =========================================================================
    - name: "{{ inventory_hostname }} | Configuration Summary"
      debug:
        msg:
          - "=============================================="
          - "Switch: {{ inventory_hostname }}"
          - "Location: {{ switch_location | default('Unknown') }}"
          - "=============================================="
          - "VLANs: {{ vlan_result.vlans_created | default(0) }} configured (mode: {{ vlan_mode }})"
          - "Trunk Ports: {{ port_result.trunk_ports_configured | default(0) }}"
          - "Access Ports: {{ port_result.access_ports_configured | default(0) }}"
          - "=============================================="
          - "Status: SUCCESS"
          - "=============================================="
