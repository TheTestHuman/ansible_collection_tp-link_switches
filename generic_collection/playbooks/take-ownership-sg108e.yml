---
# =============================================================================
# TP-Link SG108E Easy Smart Switch - Take Ownership
# =============================================================================
# Registriert einen Factory-Reset TP-Link SG108E Switch und fügt ihn zum 
# Inventory hinzu.
#
# Voraussetzungen:
#   - Switch muss Factory-Reset sein (IP: 192.168.0.1)
#   - Workstation muss im 192.168.0.x Netzwerk sein
#   - MAC-Adresse des Switches (steht auf dem Gerät)
#   - netifaces Python-Paket: pip install netifaces
#
# Usage:
#   cd ~/ansible_collection_tp-link_switches/generic_collection/
#   ansible-playbook playbooks/take-ownership-sg108e.yml
#
# =============================================================================

- name: TP-Link SG108E - Take Ownership
  hosts: localhost
  connection: local
  gather_facts: true
  
  vars_prompt:
    - name: switch_mac
      prompt: "Switch MAC-Adresse (steht auf dem Gerät, z.B. AA:BB:CC:DD:EE:FF)"
      private: false
    
    - name: switch_ip
      prompt: "Neue Switch IP-Adresse (z.B. 10.0.10.50)"
      private: false
    
    - name: switch_suffix
      prompt: "Switch-Suffix für Inventory-Name (z.B. meeting, office, lab)"
      private: false
    
    - name: switch_location
      prompt: "Standort (z.B. Meeting Room, Office)"
      private: false
      default: "Unknown"
    
    - name: switch_password
      prompt: "Neues Admin-Passwort für den Switch"
      private: true
    
    - name: update_inventory
      prompt: "Switch ins Inventory eintragen? (yes/no)"
      default: "yes"
      private: false

  vars:
    switch_name: "sg108e-{{ switch_suffix }}"
    inventory_file: "{{ playbook_dir }}/../inventory/production.yml"
    vault_file: "{{ playbook_dir }}/../inventory/vault.yml"

  tasks:
    # =========================================================================
    # PRE-FLIGHT CHECKS
    # =========================================================================
    
    - name: "PRE-CHECK: Zeige Konfiguration"
      debug:
        msg: |
          ═══════════════════════════════════════════════════════════
          TAKE OWNERSHIP - TP-Link SG108E Easy Smart Switch
          ═══════════════════════════════════════════════════════════
          
          Inventory-Name:  {{ switch_name }}
          MAC-Adresse:     {{ switch_mac }}
          Neue IP:         {{ switch_ip }}
          Standort:        {{ switch_location }}
          
          Protokoll:       UDP (Port 29808/29809)
          Factory-IP:      192.168.0.1
          
          ═══════════════════════════════════════════════════════════
    
    - name: "PRE-CHECK: Prüfe ob netifaces installiert ist"
      command: python3 -c "import netifaces"
      register: netifaces_check
      ignore_errors: yes
      changed_when: false
    
    - name: "PRE-CHECK: Fehler wenn netifaces fehlt"
      fail:
        msg: |
          ═══════════════════════════════════════════════════════════
          ✗ FEHLER: Python-Paket 'netifaces' fehlt!
          ═══════════════════════════════════════════════════════════
          
          Bitte installieren mit:
            pip install netifaces
          
          Oder:
            sudo apt install python3-netifaces
          
          ═══════════════════════════════════════════════════════════
      when: netifaces_check.rc != 0
    
    - name: "PRE-CHECK: Prüfe ob Workstation im 192.168.0.x Netzwerk ist"
      shell: ip addr | grep -q "192.168.0."
      register: network_check
      ignore_errors: yes
      changed_when: false
    
    - name: "PRE-CHECK: Warnung wenn nicht im Factory-Netzwerk"
      debug:
        msg: |
          ⚠️  WARNUNG: Workstation scheint nicht im 192.168.0.x Netzwerk zu sein!
          
          Für Factory-Reset Switches muss die Workstation im gleichen
          Netzwerk wie der Switch sein (192.168.0.x).
          
          Das Playbook wird trotzdem fortgesetzt...
      when: network_check.rc != 0

    # =========================================================================
    # TAKE OWNERSHIP
    # =========================================================================
    
    - name: "TAKE OWNERSHIP: Konfiguriere Switch"
      sg108e_take_ownership:
        switch_ip: "{{ switch_ip }}"
        switch_mac: "{{ switch_mac }}"
        username: "admin"
        password: "{{ switch_password }}"
        switch_suffix: "{{ switch_suffix }}"
      register: ownership_result
    
    - name: "TAKE OWNERSHIP: Zeige Ergebnis"
      debug:
        msg: |
          ═══════════════════════════════════════════════════════════
          ✓ SWITCH ERFOLGREICH KONFIGURIERT
          ═══════════════════════════════════════════════════════════
          
          Inventory-Name:  {{ switch_name }}
          MAC-Adresse:     {{ switch_mac }}
          IP-Adresse:      {{ switch_ip }}
          Standort:        {{ switch_location }}
          
          ═══════════════════════════════════════════════════════════
          
          HINWEIS: Der Switch hat jetzt die neue IP-Adresse.
          
          Um den Switch zu erreichen:
          1. Workstation-IP auf {{ switch_ip | regex_replace('\.[0-9]+$', '.x') }} ändern
          2. Web-Interface: http://{{ switch_ip }}
          
          ═══════════════════════════════════════════════════════════

    # =========================================================================
    # INVENTORY UPDATE
    # =========================================================================
    
    - name: "INVENTORY: Prüfe ob Switch bereits existiert"
      inventory_manager:
        inventory_path: "{{ inventory_file }}"
        switch_name: "{{ switch_name }}"
        action: check
      register: inventory_check
      when: update_inventory | lower == "yes"
    
    - name: "INVENTORY: Warnung - Switch existiert bereits"
      pause:
        prompt: |
          
          ⚠️  WARNUNG: Switch '{{ switch_name }}' existiert bereits im Inventory!
          
          Möchtest du den Eintrag überschreiben? (yes/no)
      register: overwrite_prompt
      when: 
        - update_inventory | lower == "yes"
        - inventory_check.switch_exists | default(false)
    
    - name: "INVENTORY: Setze force-Flag"
      set_fact:
        force_update: "{{ overwrite_prompt.user_input | default('no') | lower == 'yes' }}"
      when: 
        - update_inventory | lower == "yes"
        - inventory_check.switch_exists | default(false)
    
    - name: "INVENTORY: Füge Switch zum Inventory hinzu"
      inventory_manager:
        inventory_path: "{{ inventory_file }}"
        vault_path: "{{ vault_file }}"
        switch_name: "{{ switch_name }}"
        switch_password: "{{ switch_password }}"
        ansible_host: "{{ switch_ip }}"
        switch_type: "tp_link_sg108e"
        switch_model: "TL-SG108E"
        switch_location: "{{ switch_location }}"
        switch_role: "access"
        connection:
          protocol: "udp"
          port: 29808
          mac_address: "{{ switch_mac }}"
        hardware_info:
          mac_address: "{{ switch_mac }}"
        force: "{{ force_update | default(false) }}"
        action: add
      register: inventory_result
      when: 
        - update_inventory | lower == "yes"
        - (not inventory_check.switch_exists | default(false)) or (force_update | default(false))
    
    - name: "INVENTORY: Zeige Ergebnis"
      debug:
        msg: "✓ {{ inventory_result.message }}"
      when: 
        - update_inventory | lower == "yes"
        - inventory_result is defined
        - inventory_result.changed | default(false)

    # =========================================================================
    # ZUSAMMENFASSUNG
    # =========================================================================
    
    - name: "COMPLETE: Abschluss-Zusammenfassung"
      debug:
        msg: |
          ═══════════════════════════════════════════════════════════
          ✓ TAKE OWNERSHIP ABGESCHLOSSEN
          ═══════════════════════════════════════════════════════════
          
          Switch:     {{ switch_name }}
          Typ:        TP-Link SG108E Easy Smart
          MAC:        {{ switch_mac }}
          IP:         {{ switch_ip }}
          Standort:   {{ switch_location }}
          
          Inventory:  {{ 'Aktualisiert' if (inventory_result.changed | default(false)) else ('Nicht aktualisiert' if update_inventory | lower == 'yes' else 'Übersprungen') }}
          
          ═══════════════════════════════════════════════════════════
          NÄCHSTE SCHRITTE
          ═══════════════════════════════════════════════════════════
          
          1. Workstation-IP auf {{ switch_ip | regex_replace('\.[0-9]+$', '.x') }} Bereich ändern
          2. Web-Interface testen: http://{{ switch_ip }}
          3. VLANs konfigurieren:
             ansible-playbook playbooks/configure-vlans-sg108e.yml \
               -e "target_switch={{ switch_name }}"
          
          ═══════════════════════════════════════════════════════════
