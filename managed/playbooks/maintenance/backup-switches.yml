---
# =============================================================================
# Backup Switch Configurations
# =============================================================================
# Erstellt Backups der Switch-Konfigurationen
#
# Verwendung:
#   # Backup auf Switch speichern
#   ansible-playbook playbooks/maintenance/backup-switches.yml -e "backup_action=backup_switch"
#
#   # Backup lokal speichern
#   ansible-playbook playbooks/maintenance/backup-switches.yml -e "backup_action=backup_local"
#
#   # Backup vom Switch wiederherstellen (erfordert Reboot!)
#   ansible-playbook playbooks/maintenance/backup-switches.yml -e "backup_action=restore_switch"
#
#   # Von lokaler Datei wiederherstellen
#   ansible-playbook playbooks/maintenance/backup-switches.yml -e "backup_action=restore_local" -e "config_file=backups/DATEINAME.cfg"
#
#   # Einzelner Switch
#   ansible-playbook playbooks/maintenance/backup-switches.yml --limit switch-sg3210-office -e "backup_action=backup_local"
# =============================================================================

- name: Backup Switch Configurations
  hosts: managed_switches
  gather_facts: no
  connection: local
  
  vars:
    # Standard-Aktion: Lokales Backup
    backup_action: "backup_local"
    # Backup-Verzeichnis (relativ zum Playbook oder absolut)
    backup_dir: "{{ playbook_dir }}/../../backups"
    # Config-Datei für restore_local (muss via -e übergeben werden)
    config_file: ""
  
  tasks:
    - name: "{{ inventory_hostname }} | Create backup directory"
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
      run_once: true
      when: backup_action == 'backup_local'
      delegate_to: localhost

    - name: "{{ inventory_hostname }} | {{ backup_action }}"
      tp_link_config_backup:
        host: "{{ ansible_host }}"
        username: "{{ vault_switch_user }}"
        password: "{{ vault_switch_password }}"
        hostname: "{{ cli.hostname | default('SG3210') }}"
        action: "{{ backup_action }}"
        backup_dir: "{{ backup_dir }}"
        config_file: "{{ config_file if config_file else omit }}"
      register: backup_result

    - name: "{{ inventory_hostname }} | Backup Result"
      debug:
        msg: "{{ backup_result.msg }}"

    - name: "{{ inventory_hostname }} | HINWEIS: Reboot erforderlich!"
      debug:
        msg: |
          ⚠️  ACHTUNG: Das Backup wurde in startup-config wiederhergestellt.
          Die laufende Konfiguration (running-config) ist noch aktiv!
          
          Um das Backup zu aktivieren, muss der Switch neu gestartet werden:
            ssh admin@{{ ansible_host }}
            enable
            reload
      when: backup_action == 'restore_switch'
