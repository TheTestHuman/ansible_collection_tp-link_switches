---
- name: Take Ownership of Factory-Reset SG3210 Switch (2-Stage Process)
  hosts: localhost
  gather_facts: no
  
  vars:
    # Default values for factory-reset switch
    factory_default_ip: "192.168.0.1"
    factory_default_user: "admin"
    factory_default_password: "admin"
    
    # New configuration
    switch_new_password: "neinnein"
    switch_new_ip: "10.0.10.1"
    switch_new_netmask: "255.255.255.0"
    switch_new_gateway: "10.0.10.254"
    
  tasks:
    - name: "STAGE 1: Set password and enable SSH (via Telnet)"
      tp_link_initial_setup:
        default_ip: "{{ factory_default_ip }}"
        default_user: "{{ factory_default_user }}"
        default_password: "{{ factory_default_password }}"
        new_password: "{{ switch_new_password }}"
        enable_ssh: true
      register: stage1_result
      
    - name: Display Stage 1 result
      debug:
        msg: "Stage 1 completed: Password set, SSH enabled on {{ factory_default_ip }}"
        
    - name: Wait a moment for SSH to be fully active
      pause:
        seconds: 5
        
    - name: Test if SSH port is open
      wait_for:
        host: "{{ factory_default_ip }}"
        port: 22
        timeout: 10
      register: ssh_port_test
      ignore_errors: yes
      
    - name: SSH port test result
      debug:
        msg: "SSH port 22 is open on {{ factory_default_ip }}"
      when: ssh_port_test is succeeded
      
    - name: Fail if SSH port is not open
      fail:
        msg: "SSH port is not open! Cannot proceed to Stage 2."
      when: ssh_port_test is failed
      
    - name: "STAGE 2: Change IP address (via SSH)"
      tp_link_change_ip:
        current_ip: "{{ factory_default_ip }}"
        username: "{{ factory_default_user }}"
        password: "{{ switch_new_password }}"
        new_ip: "{{ switch_new_ip }}"
        new_netmask: "{{ switch_new_netmask }}"
        new_gateway: "{{ switch_new_gateway }}"
      register: stage2_result
      
    - name: Display Stage 2 result
      debug:
        msg: "Stage 2 completed: IP changed to {{ switch_new_ip }}"
        
    - name: Important Notice
      debug:
        msg: 
          - "================================================"
          - "TAKE OWNERSHIP COMPLETED SUCCESSFULLY!"
          - "================================================"
          - "Switch is now configured at: {{ switch_new_ip }}"
          - "Username: {{ factory_default_user }}"
          - "Password: {{ switch_new_password }}"
          - "SSH: Enabled"
          - "Gateway: {{ switch_new_gateway }}"
          - ""
          - "IMPORTANT: Change your workstation network to 10.0.10.x"
          - "to access the switch at the new IP address!"
          - "================================================"
